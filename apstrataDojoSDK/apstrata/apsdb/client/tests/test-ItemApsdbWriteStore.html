<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>test: Query</title>

	    <style type="text/css">
	    	@import "../../../util/test/resources/test.css";
		</style>
		
		<script type="text/javascript" src="../../../../lib/dojo/1.3.0-src/dojo/dojo.js" djConfig="parseOnLoad: true, isDesbug: true"></script>
		<script type="text/javascript" src="../../../apstrata.js" apConfig="key:'7744293024', secret:'3B45DE19C689EDAFCA47', serviceURL: 'http://apsdb.apstrata.com/sandbox-apsdb/rest', timeout: 10000"></script>
	
	    <script type="text/javascript">
	    	dojo.require("dojo.data.api.Request")
			dojo.require("dijit.form.ComboBox")
			
			function declare() {
				dojo.declare("ApsdbWriteStoreTest", 
								[apstrata.util.test.Test], 
								{
									constructor: function() {
										var self = this
										
										this.testSequence = [
																	"createStore",
																	"newItem",
																	"save",
																	"fetch1",
																	"deleteItem",
																	"save",
																	"fetch2",
																	"newItemParent",
																	"save",
																	"newItemChild",
																	"save",
																	"fetch3",
																	"deleteStore"
															]

										this.storeName = "testStore" + Math.floor(Math.random()*10000)
										
										this.client = new apstrata.apsdb.client.Client()
										this.store = new apstrata.apsdb.client.ItemApsdbWriteStore({connection: self.client.connection, 
																									apsdbStoreName: self.storeName, 
																									fields:"name, label, abbreviation, children", 
																									label: "label"})
									},
									
									newItem: function() {
										var self = this
										
										var doc = {
											name: "Alaska",
											label: "Alaska",
											abbreviation: "AL"
										}
										
										self.runner.resetTime()
										
										var handle = dojo.connect(self.store, "onNew", function(newItem, parentInfo) {
											self.runner.assert("newItem/onNew", true)
											self.executeNext()
											dojo.disconnect(handle)
										})

										self.store.newItem(doc)
									},
									
									save: function() {
										var self = this
										
										this.store.save({
											onComplete: function() {												
												self.runner.assert("save", true)
												self.executeNext()
											},
											onError: function() {
												self.runner.assert("save", false)
												self.executeNext()
											} 
										})										
									},

									save2: function() {
										var self = this
										
										this.store.save({
											onComplete: function() {												
												self.runner.assert("save", true)
												self.executeNext()
											},
											onError: function() {
												self.runner.assert("save", false)
												self.executeNext()
											} 
										})										
									},

									save3: function() {
										var self = this
										
										this.store.save({
											onComplete: function() {												
												self.runner.assert("save", true)
												self.executeNext()
											},
											onError: function() {
												self.runner.assert("save", false)
												self.executeNext()
											} 
										})										
									},

									save4: function() {
										var self = this
										
										this.store.save({
											onComplete: function() {												
												self.runner.assert("save", true)
												self.executeNext()
											},
											onError: function() {
												self.runner.assert("save", false)
												self.executeNext()
											} 
										})										
									},

									fetch1: function () {
										var self = this
	
										self.runner.resetTime()
										self.store.fetch ({
														onComplete: function(items, request) {
															self.allItems = items
															
															var works = false
															
															if (items.length == 1) {
																works = (self.store.getValue(items[0], 'abbreviation') == 'AL')
															}
															
															console.dir(items[0])
															
															console.debug(self.store.getValue(items[0], 'abbreviation'))
															
															self.runner.assert("fetch (assert newItem)", works)
															self.executeNext()
														},
														
														onError: function(errorData, request) {
															self.runner.assert("fetch", false)
															self.executeNext()
														},
														
											            query: {
															query: "x!=\"y\"",
															count: true,
															pageNumber: 1
														}
													})
									},

									deleteItem: function() {
										var self = this
										
										var handle = dojo.connect(self.store, "onDelete", function(deletedItem) {
											self.runner.assert("deleteItem/onDelete", true)
											self.executeNext()
											dojo.disconnect(handle)
										})
										
										self.store.deleteItem(self.allItems[0])
									},

									fetch2: function () {
										var self = this
	
										self.runner.resetTime()
										self.store.fetch ({
														onComplete: function(items, request) {
															self.allItems = items
															self.runner.assert("fetch (assert deleteItem)", items.length == 0)
															self.executeNext()
														},
														
														onError: function(errorData, request) {
															self.runner.assert("fetch", false)
															self.executeNext()
														},
														
											            query: {
															query: "x!=\"y\"",
															count: true,
															pageNumber: 1
														}
													})
									},
																		
									newItemParent: function() {
										var self = this
										
										var doc = {
											documentKey: "USA",
											name: "United States",
											label: "United States",
											abbreviation: "USA"
										}
										
										self.runner.resetTime()
										
										var handle = dojo.connect(self.store, "onNew", function(newItem, parentInfo) {
											self.runner.assert("newItem Parent /onNew", true)
											self.executeNext()
											dojo.disconnect(handle)
										})

										self.parentItem = self.store.newItem(doc)										
									},

									newItemChild: function() {
										var self = this
										
										var doc = {
											documentKey: "LA",
											name: "Los Angeles",
											label: "Los Angeles",
											abbreviation: "LA"
										}
										
										self.runner.resetTime()
										
										var handle = dojo.connect(self.store, "onNew", function(newItem, parentInfo) {
											self.runner.assert("newItem Child /onNew", true)
											self.executeNext()
											dojo.disconnect(handle)
										})

										self.store.newItem(doc, {parent: self.parentItem, attribute:"children"})										
									},

									fetch3: function () {
										var self = this
	
										self.runner.resetTime()
										self.store.fetch ({
														onComplete: function(items, request) {
															var child = self.store.getValue(items[0], "children")
															
															self.runner.assert("fetch (assert parent/child)", child == "LA")
															self.executeNext()
														},
														
														onError: function(errorData, request) {
															self.runner.assert("fetch", false)
															self.executeNext()
														},
														
											            query: {
															query: "apsdb.documentKey=\"USA\"",
															count: true,
															pageNumber: 1
														}
													})
									},

							    	createStore: function() {
										var self = this
	
										var operation = this.client.createStore(function() {
											self.runner.success(operation)
											self.executeNext()
										}, function() {
											self.runner.fail(operation)
										}, {store: self.storeName})
									},
									
									deleteStore: function() {
										var self = this
										var operation = self.client.deleteStore(function() {
											self.runner.success(operation)
											self.executeNext()
										}, function() {
											self.runner.fail(operation)
										}, {store: self.storeName})
									}
				})				



			}
			
	    	dojo.addOnLoad(function(){
				dojo.require("apstrata.apsdb.client.Connection")
				dojo.require("apstrata.apsdb.client.ItemApsdbReadStore")
				dojo.require("apstrata.apsdb.client.ItemApsdbWriteStore")
				dojo.require("apstrata.apsdb.client.Client")
				dojo.require("apstrata.util.logger.Logger")
				dojo.require("apstrata.util.test.TestRunner")
				dojo.require("apstrata.util.test.Test")

				declare()

				var testRunner = new apstrata.util.test.TestRunner({id:"results"})
				var test = new ApsdbWriteStoreTest()

				testRunner.run(test)
			}) // end: addOnLoad
		</script>
	</head>
	<body class="tundra">
		<h2>ApsdbWriteStore Test Suite</h2>
		<div id="results"></div>
	</body>
</html>
