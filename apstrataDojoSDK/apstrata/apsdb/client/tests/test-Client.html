<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>apstrataDojoSDK core client test suite</title>
		
		<style>
			.label {color: black;}
			.success {color: green;}
			.fail {color: red;}
			
			.operation {
				width: 100%;
				margin-bottom: 2px;
				padding: 1px;
				background-color: #dedede
			}
	
			.cell {
				display: inline-block;
				width: 150px;
			}

		</style>
		
		<script type="text/javascript" src="../../../../lib/dojo/1.3.0-src/dojo/dojo.js" djConfig="parseOnLoad: true, isDesbug: true"></script>

		<!--
			/************************************************************************
			* Set up the test by providing the proper values into 'apConfig' for:
			* - key/secret
			* - serviceURL
			* - timeout
			*************************************************************************/
		-->
		<script type="text/javascript" src="../../../apstrata.js" apConfig="key:'[my key]', secret:'[my secret]', serviceURL: 'http://apsdb.apstrata.com/sandbox-apsdb/rest', timeout: 10000"></script>
	
	    <script type="text/javascript">

			var test
			
	    	function createStore() {
				var operation = client.createStore(function() {
					test.success(operation)
					listGroups()
				}, function() {
					test.fail(operation)
				}, {store: storeName})
			}
			
			function listGroups() {
				var operation = client.listGroups(function() {
					test.success(operation)
					createGroup()
				}, function() {
					test.fail(operation)
				})				
			}
			
			function createGroup() {
				var operation = client.createGroup(function() {
					test.success(operation)
					deleteGroup()
				}, function() {
					test.fail(operation)
				}, {groupName: groupName})				
			}
			
			function deleteGroup() {
				var operation = client.deleteGroup(function() {
					test.success(operation)
					listStores()
				}, function() {
					test.fail(operation)
				}, {groupName: groupName})				
			}
			
			function listStores() {
				var operation = client.listStores(function() {
					test.success(operation)
					saveDocument()
				}, function() {
					test.fail(operation)
				})				
			}
			
			function saveDocument() {
				var operation = client.saveDocument(
					function() {
						test.success(operation)
						docKey = operation.result.document["@key"]
						query()
					}, function() {
						test.fail(operation)
					},
					{
						store: storeName,
						fields: {
							"apsdb.documentKey": "myKey",
							test: "true",
							field1: "some value",
							field2: "some other value",
							multi: ["v1", "v2", "v3"]
						}
					}
				)
			}
			
			function query() {
				var operation = client.query(
					function() {
						if ((operation.result.documents[0].fields[0]["@name"] == "field1")
							&& (operation.result.documents[0].fields[0].values[0] == "some value")) test.success(operation);
							else test.fail(operation)							
						deleteDocument()
					}, function() {
						test.fail(operation)
					},
					{
						store: storeName,
						query: "test=\"true\"",
						queryFields: "field1, field2, multi"
					}
				)
			}

			function deleteDocument() {
				var operation = client.deleteDocument(
					function() {
						test.success(operation)
						setSchema()
					}, function() {
						test.fail(operation)
					},
					{
						store: storeName,
						documentKey: docKey
					}
				)
			}
			
			function setSchema() {
				var operation = client.setSchema(
					function() {
						test.success(operation)
						getSchema()
					}, function() {
						test.fail(operation)
					},
					{
						schema: schema,
						schemaName: schemaName
					}
				)
			}
			
			function getSchema() {
				var operation = client.getSchema(
					function() {
						test.success(operation)
						listSchemas()
					}, function() {
						test.fail(operation)
					},
					{
						schemaName: schemaName,
					}
				)
			}
			
			function listSchemas() {
				var operation = client.listSchemas(
					function() {
						test.success(operation)
						listUsers()
					}, function() {
						test.fail(operation)
					})
			}
			
			function listUsers() {
				var operation = client.listUsers(
					function() {
						test.success(operation)
						saveUser()
					}, function() {
						test.fail(operation)
					})
			}
			function saveUser() {
				var operation = client.saveUser(
					function() {
						test.success(operation)
						getUser()
					}, function() {
						test.fail(operation)
					},
					{
						login: user,
						password: "pass",
						name: "dummyName"
					}
				)	
			}
			function getUser() {
				var operation = client.getUser(
					function() {
						test.success(operation)
						deleteUser()
					}, function() {
						test.fail(operation)
					}, {user: user})
			}
			
			function deleteUser() {
				var operation = client.deleteUser(
					function() {
						test.success(operation)
						saveConfiguration()
					}, function() {
						test.fail(operation)
					}, {user: user})
			}
			
			function saveConfiguration() {
				var operation = client.saveConfiguration(
					function() {
						test.success(operation)
						listConfigurations()
					}, function() {
						test.fail(operation)
					},
					{
						createSchemaACL: createSchemaACL,
						storeACLS: {
							"apsdb.DefaultStore.saveDocumentACL": "anonymosssus"
						}
					})
			}
			
			function listConfigurations() {
				var operation = client.listConfigurations(
					function() {
						test.success(operation)
						deleteStore()
					}, function() {
						test.fail(operation)
					})
			}
			
			function deleteStore() {
				var operation = client.deleteStore(function() {
					test.success(operation)
					
					test.print("<h3 class='success' id='all'>Success</h3>")
				}, function() {
					test.fail(operation)
				}, {store: storeName})
			}
			
			dojo.addOnLoad(function() {
				dojo.require("apstrata.apsdb.client.Connection")
				dojo.require("apstrata.apsdb.client.Client")
				dojo.require("apstrata.util.test.TestRunner")
				
				client = new apstrata.apsdb.client.Client()
				
				storeName = "testStore" + Math.floor(Math.random()*10000)
				groupName = "testGroup" + Math.floor(Math.random()*10000)
				schemaName= "schema"    + Math.floor(Math.random()*10000)
				user= "user"    + Math.floor(Math.random()*10000)
				createSchemaACL = "user1;user2;user3"
				
				schema="<schema><aclGroups><aclGroup name='groupOne'><read>apstrata</read><write>nasr</write><fields><field>fieldone</field></fields></aclGroup><defaultAcl><read>nasr</read><write>youss</write><delete>abd</delete></defaultAcl></aclGroups><fields><field name='fieldone'></field></fields></schema>"
				
				test = new apstrata.util.test.TestRunner({id:"results"})

				createStore()
			})
			
		</script>
	</head>
	<body>
		<h2>apstrataDojoSDK core client test suite</h2>
		<div id="results"></div>
	</body>
</html>
