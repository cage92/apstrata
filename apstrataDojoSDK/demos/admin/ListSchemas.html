<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>ap((strata store management</title>
        <style type="text/css">
            @import "../../lib/dojo/1.3.0-src/dijit/themes/nihilo/nihilo.css";
            @import "../../lib/dojo/1.3.0-src/dojox/grid/resources/nihiloGrid.css";
            @import "../../lib/dojo/1.3.0-src/dojo/resources/dojo.css";
            @import "../../apstrata/resources/css/apstrata.css";
            
            body {
                font-family: sans-serif;
                font-size: 10pt;
            } .label {
                font-size: 1em;
                color: #454545;
            } .value {
                font-size: 1.5em;
                color: #1212AA;
            } .delete {
                font-size: 1em;
                color: gray;
            } .get {
                font-size: 1em;
                color: green;
            }
        </style>
        <link rel="shortcut icon" href="images/favicon.png" type="image/png" />
        <script type="text/javascript" src="../../lib/dojo/1.3.0-src/dojo/dojo.js" djConfig="parseOnLoad: true, isDebug: true">
        </script>
        <script type="text/javascript" src="../../apstrata/apstrata.js">
        </script>
        <script type="text/javascript">
            dojo.require("dojo.parser");
            dojo.require("dijit.layout.ContentPane");
            
            var connection;
            
            dojo.addOnLoad(function(){
                dojo.require("apstrata.apsdb.client.Connection")
                dojo.require("apstrata.apsdb.client.ListSchemas")
                dojo.require("apstrata.apsdb.client.widgets.Login")
				dojo.require("apstrata.apsdb.client.widgets.SchemaContent")
                
                connection = new apstrata.apsdb.client.Connection({
                    statusWidget: "apstrata.apsdb.client.widgets.ConnectionStatus"
                })
                
                dojo.byId("url").innerHTML = connection.serviceUrl
                dojo.byId("account").innerHTML = connection.credentials.key
                
                populateSchemasList()
            })
            
            function populateSchemasList(){
                var operation = new apstrata.apsdb.client.ListSchemas(connection)
                
                dojo.connect(operation, "handleResult", function(){
                    var schemaNode = dojo.byId("schemas")
                    schemaNode.innerHTML = ""
                    
                    var s = "<table>"
                    for (var i = 0; i < operation.result.schemas.length; i++) {
                        var schemaName = operation.result.schemas[i]["@name"]
                        s += "<tr><td class='delete' title='" + schemaName + "'></td><td class='value'>" + schemaName + "</td></tr>"
                    }
                    s += "</table>"
                    
                    schemaNode.innerHTML = s
                })
                
                dojo.connect(operation, "handleError", function(){
                    // alert(operation.errorMessage)
                    login = new apstrata.apsdb.client.widgets.Login(connection)
                    login.show()
                })
                
                operation.execute();
                dojo.byId("edit").innerHTML = "edit"
                editMode = false
            }
			
            var editMode = false;
            function edit(){
                if (!editMode) {
                    dojo.byId("edit").innerHTML = "stop edit"
                    
                    dojo.query(".delete").forEach(function(node, index, arr){
						node.innerHTML = "<a href='#' class='get' onclick='getSchema(\"" + node.title + "\")'>get</a>&nbsp;&nbsp;&nbsp;"
                    });
                    
                    editMode = true
                }
                else {
                    dojo.byId("edit").innerHTML = "edit"
                    
                    dojo.query(".delete").forEach(function(node, index, arr){
                        node.innerHTML = ""
                    });
                    
                    editMode = false
                }
            }

            function getSchema(schemaName){
				dojo.require("apstrata.apsdb.client.GetSchema")
                var operation = new apstrata.apsdb.client.GetSchema(connection)
                dojo.connect(operation, "handleResult", function(){
                    content = new apstrata.apsdb.client.widgets.SchemaContent(connection,operation.result)
                    content.show()
                })
                dojo.connect(operation, "handleError", function(){
                    alert(operation.message)
                })
                
                operation.execute({
					schemaName: schemaName
                });
			}
            
            function setSchema(){
                dojo.require("apstrata.apsdb.client.SetSchema")
                var operation = new apstrata.apsdb.client.SetSchema(connection)
                
                dojo.connect(operation, "handleResult", function(){
                    populateSchemasList()
                })
                dojo.connect(operation, "handleError", function(){
                    alert(operation.message)
                })
                
                var schemaName = dojo.byId("schemaName").value
                dojo.byId("schemaName").value = ""
                
                var schema = dojo.byId("schema").value
                dojo.byId("schema").value = ""
				
                var update = dojo.byId("update").value
                dojo.byId("update").value = ""
				
                var newSchemaName = dojo.byId("newSchemaName").value
                dojo.byId("newSchemaName").value = ""
                
                operation.execute({
                    schema: schema,
					update: update,
					schemaName: schemaName,
					newSchemaName: newSchemaName
                });
            }
        </script>
    </head>
    <body class="nihilo">
        <span class="label">apstrata Service porvider URL:</span>
        <br>
        <span id="url" class="value"></span>
        <br>
        <br>
        <span class="label">account id:</span>
        <br>
        <span id="account" class="value"></span>
        <br>
        <br>
        <span class="label">Existing Schemas:</span>&nbsp;&nbsp;
        <button id="edit" onclick="edit()">
            edit
        </button>
        <span id="schemas"></span>
        <br>
        <br>
        <div>
            <div style="text-align: left;">
                <span>Schema Name:</span>
                <br>
                <input type="text" id="schemaName">
                </input>
                <br><br>
                <span>Update:</span>
                <select id="update">
                    <option value="true">true</option>
                    <option value="false" selected="true">false</option>
                </select>
                <br><br>
				<span>New Schema Name:</span>
                <br>
                <input type="text" id="newSchemaName">
                </input>
                <br><br>
                <span>Schema:</span>
                <br>
                <textarea id="schema" cols="60" rows="5">
                </textarea>
            </div>
            <button id="create" title="Set Schema" onclick="setSchema()">
                set
            </button>
        </div>
    </body>
</html>
