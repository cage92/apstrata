<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>ap((strata store management</title>
    <style type="text/css">
	    @import "../../lib/dojo/1.3.0-src/dijit/themes/nihilo/nihilo.css";
	    @import "../../lib/dojo/1.3.0-src/dojox/grid/resources/nihiloGrid.css";

        @import "../../lib/dojo/1.3.0-src/dojo/resources/dojo.css";
        @import "../../apstrata/resources/css/apstrata.css";
		
		body {font-family: sans-serif; font-size: 10pt;}
		.label {font-size: 1em; color: #454545;}
		.value {font-size: 1.5em; color: #1212AA;}
		.delete {font-size: 1em; color: gray;}
    </style>

	    <link rel="shortcut icon" href="images/favicon.png" type="image/png" />
    
	<script type="text/javascript" src="../../lib/dojo/1.3.0-src/dojo/dojo.js" djConfig="parseOnLoad: true, isDebug: true"></script>
	<script type="text/javascript" src="../../apstrata/apstrata.js"></script>

    <script type="text/javascript">
        dojo.require("dojo.parser");
        dojo.require("dijit.layout.ContentPane");

        var connection;
        
        dojo.addOnLoad(function() {
			dojo.require ("apstrata.apsdb.client.Connection")
			dojo.require ("apstrata.apsdb.client.ListGroups")
			dojo.require("apstrata.apsdb.client.widgets.Login")
			
			connection = new apstrata.apsdb.client.Connection({statusWidget: "apstrata.apsdb.client.widgets.ConnectionStatus"})
			
			dojo.byId("url").innerHTML = connection.serviceUrl
			dojo.byId("account").innerHTML = connection.credentials.key
			
			populateGroupsList()
		})

		function populateGroupsList() {
			var operation = new apstrata.apsdb.client.ListGroups(connection)
			
			dojo.connect(operation, "handleResult", function() {
				var groupNode = dojo.byId("groups")
				groupNode.innerHTML = ""

				var s = "<table>" 
				for (var i=0; i<operation.result.groups.length; i++) {
					var groupName = operation.result.groups[i]["@name"]
					s += "<tr><td class='delete' title='" + groupName + "'></td><td class='value'>" + groupName + "</td></tr>"	
				}
				s += "</table>"
				
				groupNode.innerHTML = s
			})			

			dojo.connect(operation, "handleError", function() {
				// alert(operation.errorMessage)
				login = new apstrata.apsdb.client.widgets.Login(connection)
				login.show()
			})			

			operation.execute();
			dojo.byId("edit").innerHTML = "edit"
			editMode = false
		}

		var editMode = false;
		function edit() {
			if (!editMode) {
				dojo.byId("edit").innerHTML = "stop edit"
	
				dojo.query(".delete").forEach(function(node, index, arr){
					node.innerHTML = "<a href='#' class='delete' onclick='deleteGroup(\""+ node.title +"\")'>delete</a>&nbsp;&nbsp;&nbsp;"
				});
				
				editMode = true
			} else {
				dojo.byId("edit").innerHTML = "edit"
	
				dojo.query(".delete").forEach(function(node, index, arr){
					node.innerHTML = ""
				});
				
				editMode = false
			}
		}
		
		function deleteGroup(groupName) {
			dojo.require("apstrata.apsdb.client.DeleteGroup")
			var operation = new apstrata.apsdb.client.DeleteGroup(connection)

			dojo.connect(operation, "handleResult", function() {
				populateGroupsList()
				alert(groupName + " Deleted!")
			})			
			dojo.connect(operation, "handleError", function() {
				populateGroupsList()
				alert(operation.message)
			})			

			operation.execute({groupName: groupName});
		}
		
		function createGroup() {
			dojo.require("apstrata.apsdb.client.CreateGroup")
			var operation = new apstrata.apsdb.client.CreateGroup(connection)

			dojo.connect(operation, "handleResult", function() {
				populateGroupsList()
			})			
			dojo.connect(operation, "handleError", function() {
				alert(operation.message)
			})			

			var groupName = dojo.byId("groupName").value
			dojo.byId("groupName").value = ""
			
			operation.execute({groupName: groupName});
		}
	</script>
</head>
<body class="nihilo">
	<span class="label">apstrata Service porvider URL:</span><br>
		<span id="url" class="value"></span>
		<br><br>

	<span class="label">account id:</span><br>
		<span id="account" class="value"></span>
		<br><br>

	<span class="label">Existing Groups:</span>&nbsp;&nbsp;<button id="edit" onclick="edit()">edit</button> 
		<span id="groups"></span>
		<br>
				
	<span class="label">Create New Group:</span>&nbsp;
		<input type="text" id="groupName"></input>&nbsp;&nbsp;
		<button id="create" onclick="createGroup()">create</button>
</body>
</html>