<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>ap((strata store management</title>
        <style type="text/css">
            @import "../../lib/dojo/1.3.0-src/dijit/themes/nihilo/nihilo.css";
            @import "../../lib/dojo/1.3.0-src/dojox/grid/resources/nihiloGrid.css";
            @import "../../lib/dojo/1.3.0-src/dojo/resources/dojo.css";
            @import "../../apstrata/resources/css/apstrata.css";
            
            body {
                font-family: sans-serif;
                font-size: 10pt;
            } .label {
                font-size: 1em;
                color: #454545;
            } .value {
                font-size: 1.5em;
                color: #1212AA;
            } .delete {
                font-size: 1em;
                color: gray;
            } .get {
                font-size: 1em;
                color: green;
            }
        </style>
        <link rel="shortcut icon" href="images/favicon.png" type="image/png" />
        <script type="text/javascript" src="../../lib/dojo/1.3.0-src/dojo/dojo.js" djConfig="parseOnLoad: true, isDebug: true">
        </script>
        <script type="text/javascript" src="../../apstrata/apstrata.js">
        </script>
        <script type="text/javascript">
                        var customAttributeCounter = 0;
						dojo.require("dojo.parser");
                        dojo.require("dijit.layout.ContentPane");
                        
                        var connection;
                        
                        dojo.addOnLoad(function(){
                            dojo.require("apstrata.apsdb.client.Connection")
                            dojo.require("apstrata.apsdb.client.ListUsers")
                            dojo.require("apstrata.apsdb.client.widgets.Login")
                            dojo.require("apstrata.apsdb.client.widgets.UserDetails")
                            
                            connection = new apstrata.apsdb.client.Connection({
                                statusWidget: "apstrata.apsdb.client.widgets.ConnectionStatus"
                            })
                            
                            dojo.byId("url").innerHTML = connection.serviceUrl
                            dojo.byId("account").innerHTML = connection.credentials.key
                            
                        })
                        
                        function populateUsersList(){
                            var operation = new apstrata.apsdb.client.ListUsers(connection)
                            
                            dojo.connect(operation, "handleResult", function(){
                                var usersNode = dojo.byId("users")
                                usersNode.innerHTML = ""
                                
                                var s = "<table>"
                                for (var i = 0; i < operation.result.users.length; i++) {
                                    var userName = operation.result.users[i]["@name"]
                                    s += "<tr><td class='delete' title='" + userName + "'></td><td class='value'>" + userName + "</td></tr>"
                                }
                                s += "</table>"
                                
                                usersNode.innerHTML = s
                            })
                            
                            dojo.connect(operation, "handleError", function(){
                                // alert(operation.errorMessage)
                                login = new apstrata.apsdb.client.widgets.Login(connection)
                                login.show()
                            })
                            var groupName = dojo.byId("groupName").value
                            operation.execute({
                                groupName: groupName
                            });
                            dojo.byId("edit").innerHTML = "edit"
                            editMode = false
                        }
                        
                        var editMode = false;
                        function edit(){
                            if (!editMode) {
                                dojo.byId("edit").innerHTML = "stop edit"
                                
                                dojo.query(".delete").forEach(function(node, index, arr){
                                    node.innerHTML = "<a href='#' class='get' onclick='getUser(\"" + node.title + "\")'>get</a>&nbsp;&nbsp;&nbsp;"
                                    node.innerHTML = node.innerHTML + "<a href='#' class='delete' onclick='deleteUser(\"" + node.title + "\")'>delete</a>&nbsp;&nbsp;&nbsp;"
                                });
                                
                                editMode = true
                            }
                            else {
                                dojo.byId("edit").innerHTML = "edit"
                                
                                dojo.query(".delete").forEach(function(node, index, arr){
                                    node.innerHTML = ""
                                });
                                
                                editMode = false
                            }
                        }
                        
                        function getUser(user){
                            dojo.require("apstrata.apsdb.client.GetUser")
                            var operation = new apstrata.apsdb.client.GetUser(connection)
                            dojo.connect(operation, "handleResult", function(){
            				if(operation.result != undefined){
								var result = "<result>";
								if(operation.result.user != undefined){
		            				result+= "<user name='" + operation.result.user.@name + "'>";
		            				if( operation.result.user.attributes != undefined){
		            					result+= "<attributes>";
	            						for (var i = 0; i < operation.result.user.attributes.length; i++) {
											if (operation.result.user.attributes[i] != undefined) {
	            								result+="<attribute name='" + operation.result.user.attributes[i].@name + "'>";
	            								if(operation.result.user.attributes[i].values != undefined){
													result+="<values>";
                                                    result+="<value>" + operation.result.user.attributes[i].values.value + "<value>";
	            									result+="</values>";
	            								}
												result+="</attribute>";
	            							}
	            						}
										result+= "</attributes>";	
		            				}
									result+= "</user>";
								}
								result+= "</result>";	
							}
                            content = new apstrata.apsdb.client.widgets.UserDetails(connection, result)
                            content.show()
                            })
                            dojo.connect(operation, "handleError", function(){
                                alert(operation.message)
                            })
                            
                            operation.execute({
                                user: user
                            });
                        }
                        
                        function deleteUser(userName){
                            dojo.require("apstrata.apsdb.client.DeleteUser")
                            var operation = new apstrata.apsdb.client.DeleteUser(connection)
                            
                            dojo.connect(operation, "handleResult", function(){
                                populateUsersList()
                                alert(userName + " Deleted!")
                            })
                            dojo.connect(operation, "handleError", function(){
                                populateUsersList()
                                alert(operation.message)
                            })
                            
                            operation.execute({
                                user: userName
                            });
                        }
						
                        function saveUser(){
                            dojo.require("apstrata.apsdb.client.SaveUser")
                            var operation = new apstrata.apsdb.client.SaveUser(connection)
                            
                            dojo.connect(operation, "handleResult", function(){
                                populateUsersList()
                            })
                            dojo.connect(operation, "handleError", function(){
                                alert(operation.message)
                            })
                            
                            var login = dojo.byId("login").value
                            dojo.byId("login").value = ""
                            
                            var update = dojo.byId("update").value
                            dojo.byId("update").value = ""
                            
                            var password = dojo.byId("password").value
                            dojo.byId("password").value = ""
                            
                            var name = dojo.byId("name").value
                            dojo.byId("name").value = ""
                            
							var email = dojo.byId("email").value
                            dojo.byId("email").value = ""
							
							var requestAttribs = {login: login,update: update, password: password, name: name, email: email};
							
							for(var i = 0 ; i <=customAttributeCounter ; i++){
								var customName  = dojo.byId("customName" + i).value;
								var customValue = dojo.byId("customValue" + i).value;
								if(customName.trim() != ""){
									requestAttribs[customName] = customValue
								}
							}
							operation.execute(requestAttribs);
							
                        }
                        function addAttribute(){
                            var attributesDiv = dojo.byId("attributes");
							var br = document.createElement("br");
							attributesDiv.appendChild(br);
                            var newAttribName = document.createElement("input");
                            var id = customAttributeCounter + 1;
                            newAttribName.setAttribute("id", "customName" + id);
							newAttribName.setAttribute("style", "width:95px");
                            attributesDiv.appendChild(newAttribName);
                            
                            var newAttribValue = document.createElement("input");
                            var id = customAttributeCounter + 1;
                            newAttribValue.setAttribute("id", "customValue" + id);
							newAttribValue.setAttribute("style", "width:100px");
                            attributesDiv.appendChild(newAttribValue);
							attributesDiv.appendChild(br);
							customAttributeCounter++;
                        }
                    
        </script>
    </head>
    <body class="nihilo">
        <span class="label">apstrata Service porvider URL:</span>
        <br>
        <span id="url" class="value"></span>
        <br>
        <br>
        <span class="label">account id:</span>
        <br>
        <span id="account" class="value"></span>
        <br>
        <br>
        Group Name <input type="text" id="groupName">
        </input>
        <button id="populate" onclick="populateUsersList()">
            ListUsers
        </button>
        <br>
        <br>
        <span class="label">Existing Users:</span>&nbsp;&nbsp;
        <button id="edit" onclick="edit()">
            edit
        </button>
        <span id="users"></span>
        <br>
        <br>
        <div>
            <div style="text-align: left;">
                <span>Login:</span>
                <br>
                <input type="text" id="login">
                </input>
                <br>
                <br>
                <span>Update:</span>
                <select id="update">
                    <option value="true">true</option>
                    <option value="false" selected="true">false</option>
                </select>
                <br>
                <br>
                <span>Password:</span>
                <br>
                <input value="" id="password" size="20" type="password">
                </input>
                <br>
                <br>
                <span>Name:</span>
                <br>
                <input value="" id="name">
                </input>
				<br>
                <br>
                <span>Email:</span>
                <br>
                <input value="" id="email">
                </input>
				<br>
				<br>
				<img style="cursor:pointer" onclick="addAttribute()" alt="Add attribute" title="Add attribute" src="../../lib/dojo/1.3.0-src/dijit/themes/tundra/images/treeExpand_plus.gif" />
				<br>
				<span style="width:95px">Custom Attribute</span><span style="width:100px">Value</span>
				<div id="attributes"><input style="width:95px" type="text" id="customName0"></input><input style="width:100px" type="text" id="customValue0"></input><br></div>
				<br>
            </div>
			<br>
            <button id="create" title="Save User" onclick="saveUser()">
                save user
            </button>
        </div>
		<div style="display:none" id="sample"><input type="text" id="customName"></input> Value <input type="text" id="customValue"></input></div>
        </body>
    </html>
