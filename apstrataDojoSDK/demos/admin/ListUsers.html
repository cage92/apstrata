<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>ap((strata store management</title>
        <style type="text/css">
            @import "../../lib/dojo/1.3.0-src/dijit/themes/nihilo/nihilo.css";
            @import "../../lib/dojo/1.3.0-src/dojox/grid/resources/nihiloGrid.css";
            @import "../../lib/dojo/1.3.0-src/dojo/resources/dojo.css";
            @import "../../apstrata/resources/css/apstrata.css";
            
            body {
                font-family: sans-serif;
                font-size: 10pt;
            } .label {
                font-size: 1em;
                color: #454545;
            } .value {
                font-size: 1.5em;
                color: #1212AA;
            } .delete {
                font-size: 1em;
                color: gray;
            } .get {
                font-size: 1em;
                color: green;
            }
        </style>
        <link rel="shortcut icon" href="images/favicon.png" type="image/png" />

        <script type="text/javascript" src="../../lib/dojo/1.3.0-src/dojo/dojo.js" djConfig="parseOnLoad: true, isDebug: true"></script>
        <script type="text/javascript" src="../../apstrata/apstrata.js"></script>

        <script type="text/javascript">
			dojo.require("dojo.parser");
			dojo.require("dojo.data.ItemFileReadStore")

			dojo.require("dijit.form.Button")
			dojo.require("dijit.form.ComboBox")
			dojo.require("dijit.form.CheckBox")
			dojo.require("dijit.form.Form")
			dojo.require("dijit.form.ValidationTextBox");

            dojo.require("apstrata.apsdb.client.Connection")
            dojo.require("apstrata.apsdb.client.ListUsers")
            dojo.require("apstrata.apsdb.client.widgets.Login")
            dojo.require("apstrata.apsdb.client.widgets.UserDetails")
			dojo.require("apstrata.apsdb.client.ItemApsdbReadStore")
			dojo.require("apstrata.widgets.ListEditor")

            var connection;
			var store
			var comboBox
            
			function refreshComboBox(data) {
				store = new dojo.data.ItemFileReadStore({data: data})
				comboBox = new dijit.form.ComboBox({store: store, searchAttr: 'name'})
				dojo.place(comboBox.domNode, "spnGroupNames", "only")
				
				dojo.connect(comboBox, "onChange", function(groupName) {
					displayUsersList(groupName)
				})
			}
			
			function displayUsersList(groupName) {
				hideUserForm()

				var operation = new apstrata.apsdb.client.ListUsers(connection)
				dojo.connect(operation, "handleResult", function(){
					var users = []

					dojo.forEach(operation.result.users, function(group) {
						users.push(group["@name"])						
					})

					var listEditor = new apstrata.widgets.ListEditor({
							label: "Items:",
							lockedActions: ['delete'], 
							actions: ['view'], 
							list: users
						})
					dojo.place(listEditor.domNode, "spnUsers", "only")
					
					dojo.connect(listEditor, "action", function(item, actionName) {
						
					})
				})

				operation.execute({groupName: groupName})
			}
			
			function fetchGroupNames() {
				var data;
				
				var groupsCookie = dojo.cookie("apstrata.admin.groups")
				if ((groupsCookie != undefined) && (groupsCookie != "")) {
					data = dojo.fromJson(groupsCookie)
					
					refreshComboBox(data)
				} else {
					var operation = new apstrata.apsdb.client.ListGroups(connection)
					data = {label: 'name', items: []}
					
					dojo.connect(operation, "handleResult", function() {
						dojo.forEach(operation.result.groups, function(group) {
							data.items.push({name: group["@name"]})						
						})
	
						dojo.cookie("apstrata.admin.groups", dojo.toJson(data))

						refreshComboBox(data)
					})

					operation.execute()
				}
			}
	
			function refresh() {
				dojo.cookie("apstrata.admin.groups", "")
				fetchGroupNames()
			}
			
			function saveUser() {
                dojo.require("apstrata.apsdb.client.SaveUser")
                var operation = new apstrata.apsdb.client.SaveUser(connection)
                dojo.connect(operation, "handleResult", function() {
					displayUsersList(comboBox.value)
                })
                dojo.connect(operation, "handleError", function() {
                    alert(operation.message)
                })

				if (frmUser.validate()) {
					var values = frmUser.getValues()
					if (values.update[0]) values.update = values.update[0]; else values.update = "false" 
					console.dir(values)

					operation.execute(values)
				} else {
					
				}
			}
			
			function displayUserForm() {
				dojo.byId('btnAdd').style.display = 'none'
				dojo.byId('frmUser').style.display = ''
			}
			
			function hideUserForm() {
				dojo.byId('btnAdd').style.display = ''
				dojo.byId('frmUser').style.display = 'none'
			}

            dojo.addOnLoad(function(){
				connection = new apstrata.apsdb.client.Connection({ statusWidget: "apstrata.apsdb.client.widgets.ConnectionStatus" })
				fetchGroupNames()
            })                        
        </script>
    </head>
    <body class="nihilo">
    	<span>Group Name:</span><span id="spnGroupNames"></span><button dojoType="dijit.form.Button" onClick="refresh()">refresh</button>
		<br>
		<span id="spnUsers"></span>
		<br>
		
		<br>
		<button id="btnAdd" dojoType="dijit.form.Button" onClick="displayUserForm()" style="display:;">Add User</button>
		<br>
		
		<div id="frmUser" class="rounded box shadow" style="display: none; background-color: #CDCDCD;width: 310px;" dojoType="dijit.form.Form" jsId="frmUser">
			<table>
				<tr>
					<td>Login:</td>
					<td><input type="text" name="login" required="true" dojoType="dijit.form.ValidationTextBox"/></td>
				</tr>
				<tr>
					<td>Update:</td>
					<td><div name="update" value="true" dojoType="dijit.form.CheckBox"></div></td>
				</tr>
				<tr>
					<td>Password:</td>
					<td><input type="text" name="password" required="true" dojoType="dijit.form.ValidationTextBox"/></td>
				</tr>
				<tr>
					<td>Name:</td>
					<td><input type="text" name="name" required="true" dojoType="dijit.form.ValidationTextBox"/></td>
				</tr>
				<tr>
					<td>Email:</td>
					<td><input type="text" name="email" required="true" dojoType="dijit.form.ValidationTextBox"/></td>
				</tr>
			</table>
			<br>
			<div>
				<button dojoType="dijit.form.Button" onClick="saveUser()">Save</button>
				<button dojoType="dijit.form.Button" onClick="hideUserForm()">Cancel</button>
			</div>
		</div>
    </body>
</html>
